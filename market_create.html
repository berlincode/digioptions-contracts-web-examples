<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>DigiOptions markets creation and settlement example</title>

    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo="/>
    <link rel="stylesheet" type="text/css" href="node_modules/font-awesome/css/font-awesome.min.css">

    <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="node_modules/popper.js/dist/umd/popper.min.js"></script>
    <script type="text/javascript" src="node_modules/bootstrap/dist/js/bootstrap.min.js" ></script>
    <script type="text/javascript" src="node_modules/requirejs/require.js"></script>

    <style>
button:disabled {
  cursor: not-allowed;
}
.col-3-sub {
    -ms-flex: 0 0 30%;
    flex: 0 0 30%;
    max-width: 30%;
}
    </style>
  </head>
  <body>
    <div style="width: 100%; padding-right: 15px; padding-left: 15px; max-width: 960px; margin-right: auto; margin-left: auto;">
      <h1>DigiOptions markets creation and settlement example</h1>

      <div id="modal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header" id="modalheader">
              <h5 class="modal-title" id="modaltitle">Modal title</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <pre id="modalbody">
              </pre>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <p>
        <strong>Market creation:</strong> (two stage process)
      </p>
      <ol>
        <li>
          A signature over the "facts" must be created. This signature is typically signed by a known/trusted authority.
        </li>
        <li>
          The signature may then be used to the market on the blockchain. When creating the market custom fees (and strikes)
          are applied.
        </li>
      </ol>

      <p>
        <strong>Market settlement:</strong> (two stage process)
      </p>
      <ol>
        <li>
          A trusted signature over the "facts" and the final quote. This signature <em>must</em> be created using the same
          private key that was used for the signature for market creation.
        </li>
        <li>
          The signature and the final quote must be supplied to settle the market on the blockchain.
        </li>
      </ol>

      <p>
        With this tool you can do both - creating signatures and triggering blockchain transactions.
      </p>
      <p>
        This online example is part of <a href="https://github.com/berlincode/digioptions-contracts-web-examples">https://github.com/berlincode/digioptions-contracts-web-examples</a>
      </p>

      <h2>Base data</h2>

      <form>

        <div class="form-group row">
          <label class="col-3 col-form-label" for="network">
            network:
          </label>
          <div class="col">
            <input class="form-control" type="text" id="network" name="network" placeholder="" value="" disabled />
          </div>
        </div>

        <div class="form-group row">
          <div class="col-3">
            <label class="col-form-label" for="contractAddr">
              contractAddr
            </label>
          </div>
          <div class="col">
            <div class="input-group">
              <input class="form-control" type="text" id="contractAddr" name="contractAddr" placeholder="0x..." value="" />
              <div class="input-group-append">
                <button id="dropdownContractListBtn" type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled>default contracts <span class="caret"></span></button>
                <div class="dropdown-menu dropdown-menu-right" id="dropdownContractList">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-3 col-form-label" for="signerPrivateKey">
            signerPrivateKey (private!):
          </label>
          <div class="col">
            <div class="input-group">
              <input class="form-control" type="password" id="signerPrivateKey" name="signerPrivateKey" data-toggle="password" placeholder="" value="" />
              <div class="input-group-append">
                <button type="button" class="btn btn-outline-secondary passwordToggle" value="1"><i class="fa fa-eye"></i></button>
              </div>
              <div class="input-group-append">
                <button type="button" class="btn btn-outline-secondary" id="createSigningKey" name="createSigningKey" value="1" disabled>create private key</button>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group row">
          <div class="offset-1 col-3">
            <label class="col-form-label" style="margin: 0; padding: 0;" for="signerAddr">
              -&gt; signerAddr:
            </label>
            <div class="text-muted small" style="padding-left: 1em;">
              (calc. from signerPrivateKey)
            </div>
          </div>
          <div class="col">
            <div class="input-group" style="padding-top: 3px; padding-bottom: 3px;">
              <input class="form-control" type="text" id="signerAddr" name="signerAddr" placeholder="" value="" disabled/>
              <div class="input-group-append">
                <button type="button" class="btn btn-outline-secondary js-tooltip js-copy" data-toggle="tooltip" data-placement="top" data-copy="signerAddr" title="Copy to clipboard">copy</button>
              </div>
            </div>
          </div>
        </div>

        <p>
          The private signing key ('signerPrivateKey') is used to calculate the required signatures for market creation and settlement. For market settling use the same private signing key that was
          used to create the market. Keep it safe!
        </p>
      </form>

      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link" id="marketCreate-tab" data-toggle="tab" href="#marketCreate" role="tab" aria-controls="marketCreate" aria-selected="true">
            Market creation
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="marketSettle-tab" data-toggle="tab" href="#marketSettle" role="tab" aria-controls="marketSettle" aria-selected="false">
            Market settlement
          </a>
        </li>
      </ul>

      <div class="tab-content">

        <div class="tab-pane fade" id="marketCreate" role="tabpanel" aria-labelledby="marketCreate-tab">

          <h2>Market creation</h2>

          <form>

            <div class="form-group row">
              <label class="col-3 col-form-label" for="underlyingParts">
                <span class="badge badge-primary" style="width: 2em;">1</span>
                underlyingParts:
              </label>
              <div class="col">
                <input class="form-control" type="text" id="underlyingParts" name="underlyingParts" placeholder="[&quot;ETH&quot;, &quot;USD&quot;]" value="[&quot;Test-Coin&quot;, &quot;USD&quot;]" />
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="expirationDatetime">
                <span class="badge badge-primary" style="width: 2em;">2</span>
                expirationDatetime:
              </label>
              <div class="col">
                <input class="form-control" type="text" id="expirationDatetime" name="expirationDatetime" value="" />
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="objectionPeriod">
                <span class="badge badge-primary" style="width: 2em;">3</span>
                objectionPeriod:
              </label>
              <div class="col">
                <input class="form-control" type="text" id="objectionPeriod" name="objectionPeriod" value="3600" />
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="configMarketType">
                <span class="badge badge-primary" style="width: 2em;">4</span>
                config.MarketType:
              </label>
              <div class="col">
                <div class="input-group">
                  <select class="form-control" id="configMarketType" name="configMarketType">
                    <option value="0">NAMED (0)</option>
                    <option value="1" selected>STRIKED (1)</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="configIntervalType">
                <span class="badge badge-primary" style="width: 2em;">5</span>
                config.IntervalType:
              </label>
              <div class="col">
                <div class="input-group">
                  <select class="form-control" id="configIntervalType" name="configIntervalType">
                    <option value="0">UNUSED (0)</option>
                    <option value="1" selected>USED (1)</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="marketCategory">
                <span class="badge badge-primary" style="width: 2em;">6</span>
                marketCategory:
              </label>
              <div class="col">
                <div class="input-group">
                  <select class="form-control" id="marketCategory" name="marketCategory">
                      <option value="" selected> -- no selection -- </option>
                  </select>
                </div>
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="ndigit">
                <span class="badge badge-primary" style="width: 2em;">7</span>
                ndigit:
              </label>
              <div class="col">
                <input class="form-control" type="text" id="ndigit" name="ndigit" value="0" />
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="baseUnitExp">
                <span class="badge badge-primary" style="width: 2em;">8</span>
                baseUnitExp:
              </label>
              <div class="col">
                <input class="form-control" type="text" id="baseUnitExp" name="baseUnitExp" value="18" />
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="namedRanges">
                <span class="badge badge-primary" style="width: 2em;">9</span>
                namedRanges:
              </label>
              <div class="col">
                <input class="form-control" type="text" id="namedRanges" name="namedRanges" value="[]" placeholder="[] (striked market) or e.g. [&quot;no&quot;, &quot;yes&quot;] (named market)"/>
              </div>
            </div>

            <div class="form-group row">
              <div class="offset-1 col-3">
                <label class="col-form-label" style="margin: 0; padding: 0;" for="factHash">
                  -&gt; factHash:
                </label>
                <div class="text-muted small" style="padding-left: 1em;">
                  (calc. over <span class="badge badge-secondary">1</span>&#32;-&#32;<span class="badge badge-secondary">9</span>)
                </div>
              </div>
              <div class="col">
                <div class="input-group" style="padding-top: 3px; padding-bottom: 3px;">
                  <input class="form-control" type="text" id="factHash" name="factHash" value="" disabled />
                  <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary js-tooltip js-copy" data-toggle="tooltip" data-placement="top" data-copy="factHash" title="Copy to clipboard">copy</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group row">
              <div class="col-3">
                <label class="col-form-label" style="margin: 0; padding: 0;" for="signatureFactHash">
                  signatureFactHash:<br/>
                </label><br/>
                <div class="text-muted small" style="padding-left: 1em;">
                  factHash (based on <span class="badge badge-secondary">1</span>&#32;-&#32;<span class="badge badge-secondary">9</span>)
                  signed with signerPrivateKey
                </div>
              </div>
              <div class="col">
                <textarea class="form-control" style="font-size: 80%;" id="signatureFactHash" name="signatureFactHash" rows="5"></textarea>
              </div>
              <div class="col-2">
                <button class="btn btn-secondary" style="width: 100%" id="signatureFactHashCalc" name="signatureFactHashCalc" value="1" disabled>calc.<br/>signature-<br/>FactHash</button>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-3 col-form-label" for="marketInterval">
                <span class="badge badge-primary" style="width: 2em;">10</span>
                marketInterval:
              </label>
              <div class="col">
                <div class="input-group">
                  <select class="form-control" id="marketInterval" name="marketInterval">
                      <option value="" selected> -- no selection -- </option>
                  </select>
                  <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" id="calcMarketInterval" name="calcMarketInterval" value="1" disabled>calc marketInterval</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="strikes">
                <span class="badge badge-primary" style="width: 2em;">11</span>
                strikes:
              </label>
              <div class="col">
                <input class="form-control" type="text" id="strikes" name="strikes" placeholder="[10.0, 11.0]" value="[996.0, 1000.0, 1004.0, 1008.0]" />
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="transactionFee0Percent">
                <span class="badge badge-primary" style="width: 2em;">12</span>
                transactionFee0: (in %)
              </label>
              <div class="col">
                <input class="form-control" type="text" id="transactionFee0Percent" name="transactionFee0Percent" value="0.3" />
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="feeTaker0">
                <span class="badge badge-primary" style="width: 2em;">13</span>
                feeTaker0: (address)
              </label>
              <div class="col">
                <div class="input-group">
                  <input class="form-control" type="text" id="feeTaker0" name="feeTaker0" value="" placeholder="0x..."/>
                  <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" id="setFeeTaker0" name="setFeeTaker0" value="1" disabled>marketLister owner</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="transactionFee1Percent">
                <span class="badge badge-primary" style="width: 2em;">14</span>
                transactionFee1: (in %)
              </label>
              <div class="col">
                <input class="form-control" type="text" id="transactionFee1Percent" name="transactionFee1Percent" value="0.2" />
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="feeTaker1">
                <span class="badge badge-primary" style="width: 2em;">15</span>
                feeTaker1: (address)
              </label>
              <div class="col">
                <div class="input-group">
                  <input class="form-control" type="text" id="feeTaker1" name="feeTaker1" value="" placeholder="0x..."/>
                  <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" id="setFeeTaker1" name="setFeeTaker1" value="1" disabled>your own address</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group row">
              <label class="col-3 col-form-label" for="transactionFeeSignerPercent">
                <span class="badge badge-primary" style="width: 2em;">16</span>
                transactionFeeSigner: (in %)
              </label>
              <div class="col">
                <input class="form-control" type="text" id="transactionFeeSignerPercent" name="transactionFeeSignerPercent" value="0.1" />
              </div>
            </div>
            <div class="form-group row">
              <div class="offset-1 col-3">
                <label class="col-form-label" style="margin: 0; padding: 0;" for="marketHashCalculated">
                  -&gt; marketHash:
                </label>
                <div class="text-muted small" style="padding-left: 1em;">
                  (calc. over <span class="badge badge-secondary">1</span>&#32;-&#32;<span class="badge badge-secondary">16</span> + signerAddr)
                </div>
              </div>
              <div class="col">
                <div class="input-group" style="padding-top: 3px; padding-bottom: 3px;">
                  <input class="form-control" type="text" id="marketHashCalculated" name="marketHashCalculated" value="" disabled />
                  <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary js-tooltip js-copy" data-toggle="tooltip" data-placement="top" data-copy="marketHashCalculated" title="Copy to clipboard">copy</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group row">
              <div class="offset-3 col">
                <button class="btn btn-primary" id="marketCreateBtn" name="marketCreateBtn" value="1" disabled>create new market</button>
              </div>
            </div>
          </form>
        </div>

        <div class="tab-pane fade" id="marketSettle" role="tabpanel" aria-labelledby="marketSettle-tab">

          <h2>Market settlement</h2>

          <form>

            <div class="form-group row">
              <label class="col-3 col-form-label" for="marketHash">
                marketHash:
              </label>
              <div class="col">
                <input class="form-control" type="text" id="marketHash" name="marketHash" value="" />
              </div>
            </div>

            <div class="row">
              <div class="col">

                <div class="form-group row">
                  <label class="col-3-sub col col-form-label" for="underlyingParts2">
                    <span class="badge badge-primary" style="width: 2em;">1</span>
                    underlyingParts:
                  </label>
                  <div class="col">
                    <input class="form-control" type="text" id="underlyingParts2" name="underlyingParts2" placeholder="" value="" disabled />
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-3-sub col col-form-label" for="expirationDatetime2">
                    <span class="badge badge-primary" style="width: 2em;">2</span>
                    expirationDatetime:
                  </label>
                  <div class="col">
                    <input class="form-control" type="text" id="expirationDatetime2" name="expirationDatetime2" value="" disabled />
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-3-sub col col-form-label" for="objectionPeriod2">
                      <span class="badge badge-primary" style="width: 2em;">3</span>
                      objectionPeriod:
                  </label>
                  <div class="col">
                    <input class="form-control" type="text" id="objectionPeriod2" name="objectionPeriod2" value="" disabled />
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-3-sub col col-form-label" for="configMarketType2">
                    <span class="badge badge-primary" style="width: 2em;">4</span>
                    config.MarketType:
                  </label>
                  <div class="col">
                    <div class="input-group">
                      <select class="form-control" id="configMarketType2" name="configMarketType2" disabled>
                        <option value="" selected> -- no selection -- </option>
                        <option value="0">NAMED (0)</option>
                        <option value="1">STRIKED (1)</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-3-sub col col-form-label" for="configIntervalType2">
                    <span class="badge badge-primary" style="width: 2em;">5</span>
                    config.IntervalType:
                  </label>
                  <div class="col">
                    <div class="input-group">
                      <select class="form-control" id="configIntervalType2" name="configIntervalType2" disabled>
                        <option value="" selected> -- no selection -- </option>
                        <option value="0">UNUSED (0)</option>
                        <option value="1">USED (1)</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-3-sub col col-form-label" for="marketCategory2">
                    <span class="badge badge-primary" style="width: 2em;">6</span>
                    marketCategory:
                  </label>
                  <div class="col">
                    <div class="input-group">
                      <select class="form-control" id="marketCategory2" name="marketCategory2" disabled>
                          <option value="" selected> -- no selection -- </option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-3-sub col col-form-label" for="ndigit2">
                    <span class="badge badge-primary" style="width: 2em;">7</span>
                    ndigit:
                  </label>
                  <div class="col">
                    <input class="form-control" type="text" id="ndigit2" name="ndigit2" value="" disabled />
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-3-sub col col-form-label" for="baseUnitExp2">
                    <span class="badge badge-primary" style="width: 2em;">8</span>
                    baseUnitExp:
                  </label>
                  <div class="col">
                    <input class="form-control" type="text" id="baseUnitExp2" name="baseUnitExp2" value="" disabled />
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-3-sub col col-form-label" for="namedRanges2">
                    <span class="badge badge-primary" style="width: 2em;">9</span>
                    namedRanges:
                  </label>
                  <div class="col">
                    <input class="form-control" type="text" id="namedRanges2" name="namedRanges2" value="" disabled />
                  </div>
                </div>
              </div>

              <div class="col-2">
                <button type="button" class="btn btn-outline-secondary" id="fetchMarketData" name="fetchMarketData" value="1" disabled>fetch market data from contract</button>
              </div>
            </div>

            <div class="form-group row">
              <div class="offset-1 col-3">
                <label class="col-form-label" style="margin: 0; padding: 0;" for="factHash2">
                  -&gt; factHash:
                </label>
                <div class="text-muted small" style="padding-left: 1em;">
                  (calc. over <span class="badge badge-secondary">1</span>&#32;-&#32;<span class="badge badge-secondary">9</span>)
                </div>
              </div>
              <div class="col">
                <div class="input-group" style="padding-top: 3px; padding-bottom: 3px;">
                  <input class="form-control" type="text" id="factHash2" name="factHash2" value="" disabled />
                  <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary js-tooltip js-copy" data-toggle="tooltip" data-placement="top" data-copy="factHash2" title="Copy to clipboard">copy</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-3 col-form-label" for="finalValue">
                finalValue:
              </label>
              <div class="col">
                <input class="form-control" type="text" id="finalValue" name="finalValue" value="" placeholder="e.g. 1.234 or &quot;yes&quot;" />
              </div>
            </div>

            <div class="form-group row">
              <div class="col-3">
                <label class="col-form-label" style="margin: 0; padding: 0;" for="signatureFinal">
                  signatureFinal:
                </label><br/>
                <div class="text-muted small" style="padding-left: 1em;">
                  factHash
                  (based on <span class="badge badge-secondary">1</span>&#32;-&#32;<span class="badge badge-secondary">9</span>)
                  + finalValue
                signed with signerPrivateKey
                </div>
              </div>
              <div class="col">
                <textarea class="form-control" style="font-size: 80%;" id="signatureFinal" name="signatureFinal" rows="5"></textarea>
              </div>
              <div class="col-2">
                <button class="btn btn-secondary" id="signatureFinalCalc" name="signatureFinalCalc" value="1" disabled>calc signature for market settling</button>
              </div>
            </div>

            <div class="form-group row">
              <div class="offset-3 col">
                <button class="btn btn-primary" id="marketSettleBtn" name="marketSettleBtn" value="1" disabled>settle market</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>

/* reload page on hash change */
window.addEventListener('hashchange', function(){location.reload();}, false);

    </script>


    <script>
// COPY TO CLIPBOARD
// Attempts to use .execCommand('copy') on a created text field
// Falls back to a selectable alert if not supported
// Attempts to display status in Bootstrap tooltip
// ------------------------------------------------------------------------------

function copyToClipboard(text, el) {
  var copyTest = document.queryCommandSupported('copy');
  var elOriginalText = el.attr('data-original-title');

  if (copyTest === true) {
    var copyTextArea = document.createElement('textarea');
    copyTextArea.value = text;
    document.body.appendChild(copyTextArea);
    copyTextArea.select();
    try {
      var successful = document.execCommand('copy');
      var msg = successful ? 'Copied!' : 'Whoops, not copied!';
      el.attr('data-original-title', msg).tooltip('show');
    } catch (err) {
      console.log('Oops, unable to copy');
    }
    document.body.removeChild(copyTextArea);
    el.attr('data-original-title', elOriginalText);
  } else {
    // Fallback if browser doesn't support .execCommand('copy')
    window.prompt('Copy to clipboard: Ctrl+C or Command+C, Enter', text);
  }
}

// Tooltips / Requires Bootstrap for functionality
$('.js-tooltip').tooltip();

$('.js-copy').click(function() {
  var text = document.getElementById($(this).attr('data-copy')).value;
  var el = $(this);
  copyToClipboard(text, el);
});

$('[data-toggle="password"]').each(function(){
  var b = $(this);
  var c = $(this).parent().find('.passwordToggle');
  c.addClass('input-password-hide');
  c.on('click', function(){
    if (c.hasClass('input-password-hide')){
      c.removeClass('input-password-hide').addClass('input-password-show');
      c.find('.fa').removeClass('fa-eye').addClass('fa-eye-slash');
      b.attr('type', 'text');
    } else {
      c.removeClass('input-password-show').addClass('input-password-hide');
      c.find('.fa').removeClass('fa-eye-slash').addClass('fa-eye');
      b.attr('type', 'password');
    }
  });
});

// initialize all popover infos
$('[data-toggle="popover"]').popover();

/* show an error to the user */
var modal_error = function(str){
  $('#modal').modal();
  document.getElementById('modaltitle').textContent = 'Error';
  document.getElementById('modalbody').textContent = str;
  document.getElementById('modalheader').setAttribute('style', 'background-color: #d9534f; border-top-left-radius: 3px; border-top-right-radius: 3px;');
};

/* show success to the user */
var modal_success = function(str){
  $('#modal').modal();
  document.getElementById('modaltitle').textContent = 'Success';
  document.getElementById('modalbody').textContent = str;
  document.getElementById('modalheader').setAttribute('style', 'background-color: #0480be; border-top-left-radius: 3px; border-top-right-radius: 3px;');
};

require.config({
  paths: {
    'web3': 'assets/js/web3.min',
    'web3-utils': 'assets/js/web3-utils.min',
    'eth-lib/lib/account': 'assets/js/eth-lib-account.min',
    'xhr-request-promise': 'node_modules/digioptions-tools.js/js/xhr-request-promise.min'
  },
  packages: [
    {
      name: 'factsigner',
      location: 'node_modules/factsigner',
      main: 'js/index.js'
    },
    {
      name: 'digioptions-tools.js',
      location: 'node_modules/digioptions-tools.js',
      main: 'js/index.js'
    },
    {
      name: 'digioptions-contracts.js',
      location: 'node_modules/digioptions-contracts.js',
      main: 'dist/umd/index.js'
    },
    {
      name: 'strophe.js',
      location: 'node_modules/strophe.js',
      main: 'strophe.js'
    }
  ]
});

require(
  [
    'web3',
    'factsigner',
    'digioptions-contracts.js',
    'digioptions-tools.js'
  ],
  function(Web3, factsigner, digioptionsContracts, digioptionsTools){

    var setInputFormByID = function(id, value, disable /* optional */){
      var elm = document.getElementById(id);
      if (elm){
        elm.value = value;
        if (typeof(disable) !== 'undefined'){
          if (disable) {
            elm.setAttribute('disabled', true);
          } else {
            elm.removeAttribute('disabled');
          }
        }
        // trigger all functions listening for 'input' event
        elm.dispatchEvent(new Event('input', {}));
      }
    };

    var option;
    /* fill marketCategory/marketCategory2 select field with all possible options */
    for (var marketCategoryString in factsigner.constants.marketCategory){
      var marketCategory = factsigner.constants.marketCategory[marketCategoryString];

      option = document.createElement('option');
      option.text = marketCategoryString + ' (' + marketCategory + ')';
      option.value = marketCategory;
      document.getElementById('marketCategory').add(option);

      option = document.createElement('option');
      option.text = marketCategoryString + ' (' + marketCategory + ')';
      option.value = marketCategory;
      document.getElementById('marketCategory2').add(option);
    }

    /* fill marketInterval select field with all possible options */
    for (var marketIntervalString in factsigner.constants.marketInterval){
      var marketInterval = factsigner.constants.marketInterval[marketIntervalString];

      option = document.createElement('option');
      option.text = marketIntervalString + ' (' + marketInterval + ')';
      option.value = marketInterval;
      document.getElementById('marketInterval').add(option);
    }

    var parameters = (function(){
      // parse browser's hash/query-string append parameters and try to fill out form input values
      // e.g.
      //  .../market_create.html#?contractAddr=0x0Eb7e02ED6C8a55f72551E8677eE3bbB25263016&signerPrivateKey=0x728c08b6404f3da74525183e0cf444483352e8f13a48ee40ece9185306ec7419
      //  .../market_create.html#?ethProviderWs=ws%3A%2F%2F192.168.2.116%3A12345

      var query = window.location.hash.replace(/^#?\??/, '');
      var vars = query.split('&'); // TODO amp?
      var params = {};
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        if (pair.length === 2){
          var key = decodeURIComponent(pair[0]);
          var value = decodeURIComponent(pair[1].replace(/\+/g, '%20'));
          params[key] = value;
          if (key == 'config'){
            setInputFormByID('configMarketType', (value & factsigner.constants.configMarketType.STRIKED) > 0? '1': '0', true);
            setInputFormByID('configIntervalType', (value & factsigner.constants.configIntervalType.USED) > 0? '1': '0', true);
          } else {
            setInputFormByID(key, value, true);
          }
        }
      }
      return params;
    })();

    var date;
    if (parameters.settlementDatetime){
      date = new Date(0); // The 0 there is the key, which sets the date to the epoch
      date.setUTCSeconds(parseInt(parameters.settlementDatetime));
      setInputFormByID('expirationDatetime', date.toUTCString(), true);
    }else {
      date = new Date();
      date.setTime(Math.floor((date.getTime() + (10* 60*60*1000)) / (60*60*1000)) * 60*60*1000);
      setInputFormByID('expirationDatetime', date.toUTCString());
    }

    if ((parameters.signatureFactHash) || (parameters.signatureFinal)){
      setInputFormByID('signerPrivateKey', ' - not required - (signature present)', true);
    }
    if (parameters.marketHash || parameters.signatureFinal){
      document.getElementById('marketSettle-tab').classList.add('active');
      document.getElementById('marketSettle').classList.add('active');
      document.getElementById('marketSettle').classList.add('show');
    }else{
      document.getElementById('marketCreate-tab').classList.add('active');
      document.getElementById('marketCreate').classList.add('active');
      document.getElementById('marketCreate').classList.add('show');
    }

    var addrZero = '0x0000000000000000000000000000000000000000';

    var web3;
    var web3enable;

    if (parameters.ethProviderWs){
      web3 = new Web3(parameters.ethProviderWs);
      web3enable = Promise.resolve(null);
      if (parameters.privateKey){
        web3.eth.accounts.wallet.add(parameters.privateKey);
      }
    }
    else if (window.ethereum){
      web3 = new Web3(window.ethereum);

      window.ethereum.autoRefreshOnNetworkChange = false;
      if (window.ethereum.on){
        window.ethereum.on('networkChanged', function () {
          location.reload();
        });
        window.ethereum.on('accountsChanged', function (/*accounts*/) {
          location.reload();
        });
      }

      web3enable = window.ethereum.enable()
        .catch(function(/*err*/){
          throw new Error('failed to connect to ethereum provider');
        });
    } else {
      modal_error('No web3 ethereum provider (i.e. metamask) found!');
      return;
    }

    console.log('Found provider or window.ethereum instance.');

    var getAccountSign = function(){
      try {
        return web3.eth.accounts.privateKeyToAccount(document.getElementById('signerPrivateKey').value);
      } catch (err){
        throw new Error('"signerPrivateKey" invalid');
      }
    };

    var getContractAddr = function(){
      var contractAddr = document.getElementById('contractAddr').value;
      if (! web3.utils.isAddress(contractAddr)){
        throw new Error('invalid "contractAddr"');
      }
      return contractAddr;
    };

    var parseIntOrThrowError = function(intStr, error){
      intStr = intStr.replace(/^\s+|\s+$/g, ''); // strip whitespace
      var value = Number(intStr);
      if (isNaN(value) || (intStr.length===0)){
        throw new Error(error);
      }
      return value;
    };

    var parseFloatOrThrowError = function(floatStr, baseUnitExp, error){
      try {
        floatStr = floatStr.replace(/^\s+|\s+$/g, ''); // strip whitespace
        return factsigner.parseFloatToBn(floatStr, baseUnitExp);
      } catch (err){
        throw new Error(error);
      }
    };

    var parseJsonString = function(jsonStr, error){
      try {
        jsonStr = jsonStr.replace(/^\s+|\s+$/g, ''); // strip whitespace
        var str = JSON.parse(jsonStr);
        if (typeof(str) !== 'string')
          throw new Error(error);
        return str;
      } catch (err){
        throw new Error(error);
      }
    };

    var validateAddressOrThrowError = function(addr, error){
      if (! web3.utils.isAddress(addr))
        throw new Error(error);
      return addr;
    };

    var checkJsonArrayType = function(jsonString, typeString) {
      /* this function checks the type of all elements of the array contained in a json parsable strings */
      var array;
      try {
        array = JSON.parse(jsonString);
      } catch (err){
        throw new Error('not valid json');
      }

      if (! Array.isArray(array)){
        throw new Error('not an array');
      }

      if (array.some(function(val){return typeof(val) !== typeString;})){
        throw new Error('array element of invalid type');
      }
    };
    var parseJsonArrayNumber = function(jsonString) {
      /* this function splits a json string containing numbers into its elements (as strings) without converting them */

      // remove brackets (and white spaces)
      jsonString = jsonString.replace(/^\s*\[\s*/, '').replace(/\s*\]\s*$/, '');

      if (jsonString === '')
        return [];

      return jsonString.split(',').map(
        function(floatStr){
          return floatStr.replace(/^\s+|\s+$/g, ''); // strip whitespace
        }
      );
    };

    var getBaseUnitExp = function(){return parseIntOrThrowError(document.getElementById('baseUnitExp').value, '"baseUnitExp" invalid');};
    var getExpirationDatetime = function(){return (new Date(document.getElementById('expirationDatetime').value)).getTime()/1000;};
    var getIntervalTypeUsed = function(){return Boolean(parseIntOrThrowError(document.getElementById('configIntervalType').value, '"configIntervalType" invalid'));};

    var getNamedRanges = function(){
      var jsonString = document.getElementById('namedRanges').value;
      try {
        checkJsonArrayType(jsonString, 'string');
        return JSON.parse(jsonString).map(
          function(elm){
            return factsigner.stringToNamedRange(elm);
          }
        );
      } catch (err){
        throw new Error('"namedRanges" must be an (json) array of strings');
      }
    };

    var getStrikesOrNamedRangesAsNamedRanges = function(){
      var jsonString = document.getElementById('strikes').value;
      try {
        checkJsonArrayType(jsonString, 'string');
        return JSON.parse(jsonString).map(
          function(elm){
            return factsigner.stringToNamedRange(elm);
          }
        );
      } catch (err){
        throw new Error('"strikes" must be an (json) array of strings for named markets');
      }
    };

    var getStrikesOrNamedRangesAsStrikes = function(){
      var baseUnitExp = getBaseUnitExp(); // TODO wrong error
      try {
        var jsonString = document.getElementById('strikes').value;
        checkJsonArrayType(jsonString, 'number');
        return parseJsonArrayNumber(jsonString).map(
          function(floatStr){
            return factsigner.parseFloatToBn(floatStr, baseUnitExp).toString();
          }
        );
      } catch (err){
        throw new Error('"strikes" must be an array of floats for striked markets');
      }
    };

    var getFacts = function(){
      var jsonString = document.getElementById('underlyingParts').value;
      checkJsonArrayType(jsonString, 'string');
      var underlyingParts = JSON.parse(jsonString);
      return {
        underlyingString: underlyingParts.join('\0'),
        expirationDatetime: getExpirationDatetime(),
        objectionPeriod: parseIntOrThrowError(document.getElementById('objectionPeriod').value, '"objectionPeriod" invalid'),
        config: (
          parseIntOrThrowError(document.getElementById('configMarketType').value, '"configMarketType" invalid') * factsigner.constants.configMarketTypeIsStrikedMask +
          parseIntOrThrowError(document.getElementById('configIntervalType').value, '"configIntervalType" invalid') * factsigner.constants.configIntervalTypeIsUsedMask
        ),
        marketCategory: parseIntOrThrowError(document.getElementById('marketCategory').value, '"marketCategory" invalid'),
        baseUnitExp: getBaseUnitExp(),
        ndigit: parseIntOrThrowError(document.getElementById('ndigit').value, '"ndigit" invalid'),
        namedRanges: getNamedRanges()
      };
    };

    var getMarketBaseData = function(){
      var facts = getFacts();

      // first validate facts
      factsigner.validateDataForFactHash(facts);

      return Object.assign(
        getFacts(),
        {
          strikes: (facts.config & factsigner.constants.configMarketTypeIsStrikedMask)? getStrikesOrNamedRangesAsStrikes() : getStrikesOrNamedRangesAsNamedRanges(),
          marketInterval: parseIntOrThrowError(document.getElementById('marketInterval').value, '"marketInterval" invalid'),
          signerAddr: validateAddressOrThrowError(document.getElementById('signerAddr').value, '"signerAddr" invalid'),
          feeTaker0: validateAddressOrThrowError(document.getElementById('feeTaker0').value, '"feeTaker0" invalid'),
          feeTaker1: validateAddressOrThrowError(document.getElementById('feeTaker1').value, '"feeTaker1" invalid'),
          transactionFee0: parseFloatOrThrowError(document.getElementById('transactionFee0Percent').value, 4 - 2, '"transactionFee0 x" invalid').toString(), // input in percent (float)
          transactionFee1: parseFloatOrThrowError(document.getElementById('transactionFee1Percent').value, 4 - 2, '"transactionFee1" invalid').toString(), // input in percent (float)
          transactionFeeSigner: parseFloatOrThrowError(document.getElementById('transactionFeeSignerPercent').value, 4 - 2, '"transactionFeeSigner" invalid').toString() // input in percent (float)
        }
      );
    };

    var getValue = function (){
      var isStriked = Boolean(parseIntOrThrowError(document.getElementById('configMarketType2').value, '"configMarketType" invalid'));

      var value;
      if (isStriked){
        /* striked market */
        var baseUnitExp = parseIntOrThrowError(document.getElementById('baseUnitExp2').value, '"baseUnitExp" invalid');
        value = parseFloatOrThrowError(document.getElementById('finalValue').value, baseUnitExp, '"finalValue" invalid');
      } else {
        /* named market */
// TODO is finalValue int128 like namedRange or int256?
        value = factsigner.stringToNamedRange(parseJsonString(document.getElementById('finalValue').value, '"finalValue" must be a (json) string'));
// TODO check value in namedRanges!
      }
      return value;
    };

    var getMarketHash = function (){
      // TODO validate
      return document.getElementById('marketHash').value
        .replace(/[^\x20-\x7E]/g, ''); /* remove non-visible characters (from copying hash into input field) */
    };

    var updateSignerAddress = function(){
      if ((parameters.signatureFactHash) || (parameters.signatureFinal))
        return;

      try{
        setInputFormByID('signerAddr', getAccountSign().address);
      } catch (err){
        setInputFormByID('signerAddr', err);
      }
    };

    var updateFactHash = function(){
      /* clear signatureFactHash if factHash has changed */
      if (!(parameters.signatureFactHash)){
        setInputFormByID('signatureFactHash', '', false);
      }

      try{
        setInputFormByID('factHash', factsigner.factHash(getFacts()));
      } catch (err){
        setInputFormByID('factHash', err);
      }
    };

    var updateMarketHashCalculated = function(){
      try{
        setInputFormByID('marketHashCalculated', digioptionsContracts.marketHash(getMarketBaseData()));
      } catch (err){
        setInputFormByID('marketHashCalculated', err);
      }
    };

    // automatically update signerPrivateKey
    document.querySelectorAll(
      '#signerPrivateKey'
    ).forEach(function(elem) {
      elem.addEventListener('input', function() {
        /* clear signatureFactHash if signerAddr has changed */
        setInputFormByID('signatureFactHash', '', false);

        updateSignerAddress();
      });
    });

    // automatically update factHash
    document.querySelectorAll(
      '#underlyingParts, #expirationDatetime, #objectionPeriod, #configMarketType, #configIntervalType, #marketCategory, #ndigit, #baseUnitExp, #namedRanges'
    ).forEach(function(elem) {
      elem.addEventListener('input', function() {
        updateFactHash();
      });
    });

    // automatically update marketHashCalculated
    document.querySelectorAll(
      '#signerAddr, ' +
      '#underlyingParts, #expirationDatetime, #objectionPeriod, #configMarketType, #configIntervalType, #marketCategory, #ndigit, #baseUnitExp, #namedRanges, ' +
      '#marketInterval, #strikes, #transactionFee0Percent, #transactionFee1Percent, #transactionFeeSignerPercent, #feeTaker0, #feeTaker1'
    ).forEach(function(elem) {
      elem.addEventListener('input', function() {
        updateMarketHashCalculated();
      });
    });

    document.querySelectorAll(
      '#finalValue'
    ).forEach(function(elem) {
      elem.addEventListener('input', function() {
        /* clear signatureFinal */
        setInputFormByID('signatureFinal', '', false);
      });
    });

    // set initial factHash/marketHashCalculated
    updateSignerAddress();
    updateFactHash();
    updateMarketHashCalculated();

    var dataNetworks = digioptionsTools.dataNetworks;
    var account;

    web3enable
      .then(function(){
        return web3.eth.getAccounts();
      })
      .then(function(accounts){
        account = accounts[0];
        return web3.eth.net.getId();
      })
      .then(function(netId){
        var network = digioptionsTools.dataNetworksUtils.getNetworkByNetId(netId);
        var dataNetwork = dataNetworks[network];
        var networkName = dataNetwork? dataNetwork.name : 'unknown';
        setInputFormByID('network', networkName);

        if ((! dataNetwork) || (! dataNetwork.contractDescriptions) || (dataNetwork.contractDescriptions.length === 0)){
          var header = document.createElement('h6');
          header.setAttribute('class', 'dropdown-header');
          header.textContent = 'No default contracts for network "' + networkName + '" known';
          document.getElementById('dropdownContractList').appendChild(header);
        } else {

          var contracts = {};
          var addItem = function(name, contractAddr){
            if (!contracts[contractAddr]){
              contracts[contractAddr] = true; // add each addr only once

              var anchor = document.createElement('a');
              anchor.setAttribute('href', '#');
              anchor.onclick = function(evt){
                evt.preventDefault();
                setInputFormByID('contractAddr', contractAddr);
              };
              anchor.textContent = name + ': '+ contractAddr.substring(0, 10) + '...';
              anchor.setAttribute('class', 'dropdown-item');

              document.getElementById('dropdownContractList').appendChild(anchor);
            }
          };

          if (dataNetwork){
            for (var contractDescriptionIdx in dataNetwork.contractDescriptions){
              var contractAddr = dataNetwork.contractDescriptions[contractDescriptionIdx].addr;

              // TODO set one contract as default ?
              digioptionsContracts.getContractInfo(web3, contractAddr)
                .then(function(contractDescription){
                  if (contractDescription.contractType !== digioptionsContracts.constants.contractType.DIGIOPTIONSMARKETS){
                    addItem('marketListerContract', contractAddr);
                  }
                  addItem('marketsContract', contractDescription.marketsAddr);
                })
                .catch(function(/*err*/){
                  /* ignore error */
                });
            }
          }
        }

        document.getElementById('createSigningKey').onclick = function(evt){
          evt.preventDefault();
          setInputFormByID('signerPrivateKey', web3.eth.accounts.create().privateKey);
        };

        document.getElementById('calcMarketInterval').onclick = function(evt){
          evt.preventDefault();
          if (! getIntervalTypeUsed()){
            setInputFormByID('marketInterval', factsigner.constants.marketInterval.NONE);
            return;
          }
          try {
            var contract = new web3.eth.Contract(
              digioptionsContracts.digioptionsMarketListerAbi(),
              getContractAddr()
            );
            contract.methods.calcMarketInterval(getExpirationDatetime()).call()
              .then(function(marketInterval){
                if (marketInterval === null)
                  throw new Error('cannot determine "marketInterval":\r\nmaybe "expirationDatetime" is invalid or not in the future ?');
                setInputFormByID('marketInterval', marketInterval);
              })
              .catch(function(err){
                modal_error(
                  'cannot determine "marketInterval":\r\nmaybe "expirationDatetime" is invalid or not in the future ?\r\n\r\n' +
                  err + '\r\n\r\nstack trace:\r\n' + err.stack
                );
              });
          } catch (err){
            modal_error(
              'cannot determine "marketInterval"\r\n\r\n' +
              err + '\r\n\r\nstack trace:\r\n' + err.stack
            );
          }
        };

        document.getElementById('signatureFactHashCalc').onclick = function(evt){
          evt.preventDefault();
          try {
            var accountSign = getAccountSign();
            var factHash = factsigner.factHash(getFacts());
            var signature = factsigner.signFactsignerMessage(factHash, accountSign.privateKey);
            setInputFormByID('signatureFactHash', JSON.stringify(signature, null, 2));
          } catch (err){
            setInputFormByID('signatureFactHash', err);
          }
        };

        document.getElementById('signatureFinalCalc').onclick = function(evt){
          evt.preventDefault();
          try {

            var value = getValue();

            var hash = factsigner.settlementHash(
              document.getElementById('factHash2').value,
              value,
              factsigner.constants.settlementType.FINAL
            );
            var signature_market_expire = factsigner.signFactsignerMessage(hash, getAccountSign().privateKey);
            setInputFormByID('signatureFinal', JSON.stringify(signature_market_expire, null, 2));
          } catch (err){
            setInputFormByID('signatureFinal', err);
          }
        };

        document.getElementById('fetchMarketData').onclick = function(evt){
          evt.preventDefault();
          try {
            var contractAddr = getContractAddr();
            var marketHash = getMarketHash();
            var contract;

            digioptionsContracts.getContractInfo(web3, contractAddr)
              .then(function(contractDescription){
                contract = contractDescription.contractMarketLister || contractDescription.contractMarkets;
                if (contractDescription.contractType !== digioptionsContracts.constants.contractType.DIGIOPTIONSMARKETS){
                  // always use marketsContracts
                  contract = contractDescription.contractMarkets;
                }

                return contract.methods.getMarketDataByMarketHash(addrZero, marketHash).call();
              })
              .then(function(marketData){

                if (Number(marketData.marketBaseData.expirationDatetime) === 0){
                  throw new Error('market does not (yet) exists');
                }

                var date = new Date(0); // The 0 there is the key, which sets the date to the epoch
                date.setUTCSeconds(marketData.marketBaseData.expirationDatetime);

                setInputFormByID('underlyingParts2', JSON.stringify(marketData.marketBaseData.underlyingString.split('\0')));
                setInputFormByID('expirationDatetime2', date.toUTCString());
                setInputFormByID('objectionPeriod2', marketData.marketBaseData.objectionPeriod);
                setInputFormByID('configMarketType2', (marketData.marketBaseData.config & factsigner.constants.configMarketTypeIsStrikedMask)? 1 : 0);
                setInputFormByID('configIntervalType2', (marketData.marketBaseData.config & factsigner.constants.configIntervalTypeIsUsedMask)? 1 : 0);
                setInputFormByID('marketCategory2', marketData.marketBaseData.marketCategory);
                setInputFormByID('ndigit2', marketData.marketBaseData.ndigit);
                setInputFormByID('baseUnitExp2', marketData.marketBaseData.baseUnitExp);
                setInputFormByID('namedRanges2', (marketData.marketBaseData.config & factsigner.constants.configMarketTypeIsStrikedMask) ? '[ ]' : JSON.stringify(marketData.marketBaseData.strikes.map(function(x){return factsigner.namedRangeToString(web3.utils.toHex(x));}), null, 1));

                setInputFormByID('factHash2', factsigner.factHash(marketData.marketBaseData));

                if (! parameters.signatureFinal){
                  /* clear signatureFinal */
                  setInputFormByID('signatureFinal', '', false);
                }
              })
              .catch(function(err){
                modal_error(err + '\r\n\r\nstack trace:\r\n' + err.stack);
              });
          } catch (err){
            modal_error(err + '\r\n\r\nstack trace:\r\n' + err.stack);
          }
        };

        document.getElementById('marketCreateBtn').onclick = function(evt){
          evt.preventDefault();
          try {

            var marketBaseData = getMarketBaseData();
            var marketHash = digioptionsContracts.marketHash(marketBaseData);
            var contract;

            var signature;
            try {
              signature = JSON.parse(document.getElementById('signatureFactHash').value);
            } catch (err){
              throw new Error('"signatureFactHash" invalid');
            }

            if (! web3.utils.isAddress(account)){
              throw new Error('no account found - maybe you need to unlock MetaMask');
            }

            if (parameters.checkFeeTaker1IsTransactionSigner){
              if (marketBaseData.feeTaker1.toLowerCase() !== account.toLowerCase()){
                throw new Error('"feeTaker1" should be your current account address');
              }
            }

            digioptionsContracts.getContractInfo(web3, getContractAddr())
              .then(function(contractDescription){
                contract = contractDescription.contractMarketLister || contractDescription.contractMarkets;

                if (contractDescription.contractType !== digioptionsContracts.constants.contractType.DIGIOPTIONSMARKETS){
                  return contract.methods.getMarketListerInfo().call();
                }
                return Promise.resolve(null);
              })
              .then(function(marketListerInfo){
                if (marketListerInfo){
                  var marketListerDescription = digioptionsContracts.marketListerInfoToMarketListerDescription(
                    web3,
                    marketListerInfo
                  );
                  if (marketBaseData.feeTaker0.toLowerCase() !== marketListerDescription.listerValues.ownerAddr.toLowerCase()){
                    //console.log('marketListerDescription', marketListerDescription); // TODO
                    throw new Error(marketBaseData.feeTaker0.toLowerCase() + ' !== ' + marketListerDescription.listerValues.ownerAddr.toLowerCase());
                  }
                }
                return contract.methods.getMarketDataByMarketHash(addrZero, marketHash).call();
              })
              .then(function(marketData){

                if (Number(marketData.marketBaseData.expirationDatetime) !== 0){
                  throw new Error('market already exists');
                }

                return contract.methods.calcMarketInterval(Number(getFacts().expirationDatetime)).call();
              })
              .then(function(marketInterval) {

                if (! getIntervalTypeUsed()){
                  marketInterval = factsigner.constants.marketInterval.NONE;
                }
                if (Number(marketInterval) !== Number(marketBaseData.marketInterval)){
                  throw new Error('"marketInterval" invalid (expected marketInterval: ' + marketInterval + ')');
                }

                return contract.methods.createMarket(
                  marketBaseData,
                  false, /* testMarket */
                  signature /* signature */
                )
                  .estimateGas({
                    from: account,
                  });
              })
              .then(function(gasAmount){
                var marketUrl = digioptionsTools.dataNetworksUtils.getDigioptionsUrl(
                  'pageMarket',
                  {network: network, contractAddr: getContractAddr(), marketHash: marketHash},
                  false /* relative url */
                );

                return contract.methods.createMarket(
                  marketBaseData,
                  false, /* testMarket */
                  signature /* signature */
                )
                  .send({
                    from: account,
                    gas: Math.round(gasAmount * 1.2)
                  })
                  .on('transactionHash', function(/*transactionHash*/){
                    modal_success(
                      'Create market transaction sent.\r\n\r\n' +
                      'Do not forget to remember the marketHash:\r\n' +
                      marketHash + '\r\n\r\n' +
                      (marketUrl?
                        ('If the transaction succeeds you can view the market at:\r\n' + marketUrl)
                        :
                        ''
                      )
                    );
                  });
              })
              .then(function(){
                console.log('transaction success');
              })
              .catch(function(err){
                modal_error(err + '\r\n\r\nstack trace:\r\n' + err.stack);
              });
          } catch (err){
            modal_error(err + '\r\n\r\nstack trace:\r\n' + err.stack);
          }
        };

        document.getElementById('marketSettleBtn').onclick = function(evt){
          evt.preventDefault();
          try {

            var marketHash = getMarketHash();
            var contract;
            var signature;
            try {
              // TODO add support for named values
              signature = JSON.parse(document.getElementById('signatureFinal').value);
            } catch (err){
              throw new Error('"signatureFinal" invalid');
            }

            digioptionsContracts.getContractInfo(web3, getContractAddr())
              .then(function(contractDescription){
                contract = contractDescription.contractMarketLister || contractDescription.contractMarkets;
                if (contractDescription.contractType !== digioptionsContracts.constants.contractType.DIGIOPTIONSMARKETS){
                  // always use marketsContracts
                  contract = contractDescription.contractMarkets;
                }

                return contract.methods.getMarketDataByMarketHash(addrZero, marketHash).call();
              })
              .then(function(marketData){
                if (Number(marketData.marketBaseData.expirationDatetime) === 0){
                  throw new Error('market does not (yet) exists');
                }

                if (marketData.marketState.settled) {
                  throw new Error('market is already settled');
                }

                if (! web3.utils.isAddress(account)){
                  throw new Error('no account found - maybe you need to unlock MetaMask');
                }

                if (parameters.checkFeeTaker1IsTransactionSigner){
                  if (marketData.marketBaseData.feeTaker1.toLowerCase() !== account.toLowerCase()){
                    throw new Error('"feeTaker1" should be your current account address');
                  }
                }

                var value = getValue();

                return contract.methods.settlement(
                  marketHash,
                  signature,
                  value.toString(),
                  [], // users // TODO
                  [] // TODO offerHash
                )
                  .estimateGas({
                    from: account,
                  });
              })
              .then(function(gasAmount){

                var value = getValue();

                return contract.methods.settlement(
                  marketHash,
                  signature,
                  value.toString(),
                  [], // users // TODO
                  [] // TODO offerHash
                )
                  .send({
                    from: account,
                    gas: Math.round(gasAmount * 1.2)
                  })
                  .on('transactionHash', function(/*transactionHash*/){
                    modal_success('settlement transaction sent');
                  });
              })
              .then(function(){
                //console.log('transaction success');
              })
              .catch(function(err){
                modal_error(err);
              });
          } catch (err){
            modal_error(err + '\r\n\r\nstack trace:\r\n' + err.stack);
          }
        };

        document.getElementById('setFeeTaker0').onclick = function(evt){
          evt.preventDefault();
          try {
            var contractAddr = getContractAddr();
            var contract;

            digioptionsContracts.getContractInfo(web3, contractAddr)
              .then(function(contractDescription){
                contract = contractDescription.contractMarketLister || contractDescription.contractMarkets;

                if (contractDescription.contractType !== digioptionsContracts.constants.contractType.DIGIOPTIONSMARKETLISTER){
                  throw new Error('The given contract address:\r\n' + contractAddr + '\r\n is not a marketLister contract.');
                }
                return contract.methods.getMarketListerInfo().call();
              })
              .then(function(marketListerInfo){
                var marketListerDescription = digioptionsContracts.marketListerInfoToMarketListerDescription(
                  web3,
                  marketListerInfo
                );
                setInputFormByID('feeTaker0', marketListerDescription.listerValues.ownerAddr);

              })
              .catch(function(err){
                modal_error(
                  err + '\r\n\r\nstack trace:\r\n' + err.stack
                );
              });
          } catch (err){
            modal_error(
              err + '\r\n\r\nstack trace:\r\n' + err.stack
            );
          }
        };

        document.getElementById('setFeeTaker1').onclick = function(evt){
          evt.preventDefault();
          setInputFormByID('feeTaker1', account);
        };

        // enable buttons after handlers are installed (e.g. "create signing key" / "create new market")
        document.getElementById('marketCreateBtn').removeAttribute('disabled');
        document.getElementById('marketSettleBtn').removeAttribute('disabled');
        document.getElementById('fetchMarketData').removeAttribute('disabled');
        if (! parameters.marketInterval){
          document.getElementById('calcMarketInterval').removeAttribute('disabled');
        }
        if (! parameters.feeTaker0){
          document.getElementById('setFeeTaker0').removeAttribute('disabled');
        }
        if ((! parameters.feeTaker1) && (account)){
          document.getElementById('setFeeTaker1').removeAttribute('disabled');
        }
        if (! parameters.contractAddr){
          document.getElementById('dropdownContractListBtn').removeAttribute('disabled');
        }
        if (!((parameters.signerPrivateKey) || (parameters.signatureFactHash) || (parameters.signatureFinal))){
          document.getElementById('createSigningKey').removeAttribute('disabled');
        }
        if (! parameters.signatureFactHash){
          document.getElementById('signatureFactHashCalc').removeAttribute('disabled');
        }
        if (!parameters.signatureFinal){
          document.getElementById('signatureFinalCalc').removeAttribute('disabled');
        }
      })
      .catch(function(err){
        modal_error(err + '\r\n\r\nstack trace:\r\n' + err.stack);
      });

  }
);

    </script>
  </body>
</html>
